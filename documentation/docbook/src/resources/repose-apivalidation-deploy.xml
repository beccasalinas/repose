<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book [
<!-- product name is likely to change; parameterize full name, abbreviated name, expanded name -->
<!ENTITY PRODNAME "Repose">
<!ENTITY PRODABBREV "Repose">
<!ENTITY PRODEXPAND "REstful PrOxy Service Engine">
    <!-- Some useful entities borrowed from HTML -->
    <!ENTITY ndash  "&#x2013;">
    <!ENTITY mdash  "&#x2014;">
    <!ENTITY hellip "&#x2026;">

    <!-- Useful for describing APIs -->
    <!ENTITY GET    '<command xmlns="http://docbook.org/ns/docbook">GET</command>'>
    <!ENTITY PUT    '<command xmlns="http://docbook.org/ns/docbook">PUT</command>'>
    <!ENTITY POST   '<command xmlns="http://docbook.org/ns/docbook">POST</command>'>
    <!ENTITY DELETE '<command xmlns="http://docbook.org/ns/docbook">DELETE</command>'>

    <!ENTITY CHECK  '<inlinemediaobject xmlns="http://docbook.org/ns/docbook">
        <imageobject>
        <imagedata fileref="img/Check_mark_23x20_02.svg"
        format="SVG" scale="60"/>
        </imageobject>
        </inlinemediaobject>'>

    <!ENTITY ARROW  '<inlinemediaobject xmlns="http://docbook.org/ns/docbook">
        <imageobject>
        <imagedata fileref="img/Arrow_east.svg"
        format="SVG" scale="60"/>
        </imageobject>
        </inlinemediaobject>'>
]>
<!-- in BOOK below, add status="draft" to set watermark on cover and left margin -->
<book version="5.0" xmlns="http://docbook.org/ns/docbook"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns:m="http://www.w3.org/1998/Math/MathML"
      xmlns:html="http://www.w3.org/1999/xhtml"
      xmlns:db="http://docbook.org/ns/docbook" 
      xml:id="Repose-Ratelimiting-Deployment-Guide">
    <?rax pdf.url="../../repose-ratelimiting-deploy.pdf"?>
    <title>&PRODNAME; API Validation Component Deployment
        Handbook</title>
    <!-- set watermark on cover and left margin 
        <?rax status.bar.text="CONFIDENTIAL"?>
    -->
    <?rax title.font.size="35px" subtitle.font.size="16px"?>
    <titleabbrev>&PRODABBREV; Translation Deployment</titleabbrev>
    <info>
        <author>
            <personname>
                <firstname/>
                <surname/>
            </personname>
            <affiliation>
                <orgname>Rackspace Cloud</orgname>
            </affiliation>
        </author>
        <copyright>
            <year>2010</year>
            <year>2011</year>
            <year>2012</year>
            <holder>Rackspace US, Inc.</holder>
        </copyright>
        <releaseinfo>v2.4.1</releaseinfo>
        <productname>&PRODNAME;</productname>
        <pubdate>2012-12-11</pubdate>
        <legalnotice role="apache2">
            <annotation>
                <remark>Copyright details are filled in by the template.</remark>
            </annotation>
        </legalnotice>
        <abstract>
            <para>This document is intended for systems administrators
                interested in configuring their service to use the
                API Validation component of the &PRODEXPAND;. </para>
        </abstract>
        <revhistory>
            <revision>
                <date>2012-12-11</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem>
                            <para>Initial release as internal
                                draft.</para>
                        </listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
        </revhistory>
    </info>
    <chapter xml:id="Overview-d1e85">
        <title>About This Document</title>
            <para> 
                The purpose of this handbook is to facilitate deployment of &PRODNAME;'s API Validation component. This handbook is not a tutorial. It provides basic information
                that will help you understand and deploy this &PRODNAME; component, but you must
                adapt this information to suit your own configuration. 
            </para>  
            <para>
                This handbook is focused on one &PRODNAME; component.
                Other &PRODNAME; components are documented in companion handbooks.
            </para>
        <section xml:id="Document_Change_History-d1e102">
            <title>Document Change History</title>
            <para>This version of the handbook replaces and obsoletes all previous versions.
            The most recent changes are described in the table below: </para>
            <?rax revhistory?>
        </section>
        <xi:include href="chapters/available-doc.xml"/>
    </chapter>
    <!-- naming this section xml:id="Introduction-000" to make it the first page opened in HTML, matching <webhelpDefaultTopic>Introduction-000.html</webhelpDefaultTopic> in pom.xml -->
    <chapter xml:id="Introduction-000">
        <title>Introduction to the API Validation Component of
            &PRODNAME;</title>
        <para> API validation examines an API request and confirms
            that it is constructed correctly before forwarding it to
            its destination. </para>
        <para> To use &PRODNAME; for API validation, you must add the
            API validation component as a filter in your &PRODNAME;
            configuration. You can learn more about customizing your
            &PRODNAME; configuration by reading the <link
                xlink:href="http://openrepose.org/documentation/repose-deploy/content/Introduction-000.html"
                >Repose Deployment Handbook</link> and by examining a
                <link
                xlink:href="https://github.com/rackspace/repose/blob/master/project-set/core/core-lib/src/main/resources/META-INF/schema/examples/system-model.cfg.xml"
                >basic system model configuration</link> in GitHub. </para>
        <para> 
            To understand the &PRODNAME; API validation filter,
            you should understand several related concepts:
            <itemizedlist>
                <listitem><para>Application Programming Interface (API)</para></listitem>
                <listitem><para>Web Application Description Language (WADL)</para></listitem>
                <listitem><para>stylesheets</para></listitem>
            </itemizedlist>
        </para>
        <tip>
            <para> API validation processing is controlled by
                    <code>validator.cfg.xml</code>; to change your
                validation configuration, edit
                    <code>validator.cfg.xml</code>. You can see an
                annotated example of <code>validator.cfg.xml</code> in
                    <xref linkend="Configuration-d1e365"/>. </para>
        </tip>
        <section xml:id="Intro_API-000">
            <title>Understanding APIs and the API Validation Component of &PRODNAME;</title>
            <para>Explain the scope of what we can validate: only REST
                API requests.</para>
        </section>
        <section xml:id="Intro_WADL-000">
            <title>Understanding WADL and the API Validation Component of &PRODNAME;</title>
            <para>Explain how we use WADL to describe what we are
                validating.</para>
        </section>        
        <section xml:id="Intro_stylesheet-000">
            <title>Understanding Stylesheets and the API Validation Component of &PRODNAME;</title>
            <para>Explain how we use stylesheets to recognize what is
                and is not valid and possibly to make the invalid
                valid.</para>
        </section>
    </chapter>
    <chapter xml:id="Configuration-d1e365">
        <title>Configuration</title>
        <tip>
            <para> Before attempting to customize your validation
                configuration and its stylesheets, familiarize
                yourself with the basic &PRODNAME; concepts and
                deployment methods in our <link
                    xlink:href="hhttp://openrepose.org/documentation/repose-intro/content/Introduction-000.html"
                    >Getting Started</link> document. </para>
        </tip>
        <para> The API validation component obtains its configuration,
            including its API endpoint, from a file named
                <code>validator.cfg.xml</code>. We have included an
            annotated example of a valid
                <code>validator.cfg.xml</code> in this chapter.</para>
        <para> To change your validation configuration, edit
                <code>validator.cfg.xml</code> at any time. </para> 
        <para>
            The validation component uses your validation configuration to recognize whether an API request is valid. 
            If an API request is not valid, the validation component handles it as specified in your response messaging configuration at <code>response-messaging.cfg.xml</code>. 
        </para>
        <section xml:id="Customizing_Validation_Configuration-d1e375">
        <title>Customizing a Validation Configuration</title>
        <para> Your validation configuration in
                    <code>validator.cfg.xml</code> will resemble the
                following example: </para>
        <example>
            <title>Validation Configuration</title>
            <programlistingco>
                <areaspec>
                    <area xml:id="cfg.validators"
                        units="linecolumn" coords="4 1"/>
                    <area xml:id="cfg.multi-role-match"
                        units="linecolumn" coords="5 5"/>
                    <area xml:id="cfg.validator"
                        units="linecolumn" coords="10 5"/>
                    <area xml:id="cfg.role" 
                        units="linecolumn" coords="11 9"/>
                    <area xml:id="cfg.default" 
                        units="linecolumn" coords="12 9"/>
                    <area xml:id="cfg.wadl" 
                        units="linecolumn" coords="13 9"/>
                    <area xml:id="cfg.dot-output" 
                        units="linecolumn" coords="14 9"/>
                    <area xml:id="cfg.check-well-formed" 
                        units="linecolumn" coords="15 9"/>
                    <area xml:id="cfg.check-xsd-grammar" 
                        units="linecolumn" coords="16 9"/>
                    <area xml:id="cfg.check-elements" 
                        units="linecolumn" coords="17 9"/>
                    <area xml:id="cfg.check-plain-params" 
                        units="linecolumn" coords="18 9"/>
                    <area xml:id="cfg.do-xsd-grammar-transform" 
                        units="linecolumn" coords="19 9"/>
                    <area xml:id="cfg.enable-pre-process-extension" 
                        units="linecolumn" coords="20 9"/>
                    <area xml:id="cfg.remove-dups" 
                        units="linecolumn" coords="21 9"/>
                    <area xml:id="cfg.xpath-version" 
                        units="linecolumn" coords="22 9"/>
                    <area xml:id="cfg.validate-checker" 
                        units="linecolumn" coords="23 9"/>
                    <area xml:id="cfg.xsl-engine" 
                        units="linecolumn" coords="24 9"/>
                    <area xml:id="cfg.use-saxon" 
                        units="linecolumn" coords="25 9"/>
                    <area xml:id="cfg.enable-ignore-xsd-extension" 
                        units="linecolumn" coords="26 9"/>
                    <area xml:id="cfg.join-xpath-checks" 
                        units="linecolumn" coords="27 9"/>
                    <area xml:id="cfg.check-headers" 
                        units="linecolumn" coords="39 9"/>
                </areaspec>
                <programlisting language="xml">
<xi:include href="samples/repose-apivalidation-validator.cfg.xml" parse="text"/>
            </programlisting>
            </programlistingco>
        </example>
        <para> Key elements of the preceding example are labeled with
            callouts and explained below: </para>
        <calloutlist>
            <callout arearefs="cfg.validators">
                <para> Multiple validators can be defined within this <code>&lt;validators&gt;</code> wrapper.</para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.multi-role-match">
                <para>
                    When set to <code>true</code>, validation is attempted for the <code>X-Roles</code> header; validation is attempted for every match until one is valid.
                </para>
                <para> Otherwise, validation is attempted for the
                            <code>X-Roles</code> header and validation is
                        attempted for only the first match. </para>
                <para>
                    If no matches are found, only the validator which specifies <code>default="true"</code> is used.
                </para>
                <para>
                    If matches are found but none of them are valid, only the validator which specifies <code>default="true"</code> is used.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.validator">
                <para> One validator is defined within this <code>&lt;validator&gt;</code> wrapper.
                    </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.role">
                <para> Match this validator to requests according to the <code>X-Roles</code> header with highest quality value.</para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.default">
                <para>  When set to <code>true</code>, match this validator to requests which do not pass an <code>X-Roles</code> header. </para>
                <para>
                    Only one validator can specify <code>default="true"</code>.
                    In this example, in the validator labeled "VALIDATOR 1", you can see the validator identified as the default.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.wadl">
                <para> This attribute specifies the location of the WADL to be examined by this validator. 
                    If a relative path is specified, then this is a URI relative to the &PRODNAME; configuration directory. 
                    To validate a WADL outside the current file system, specify the URL of that WADL. 
                </para>
                <para>This attribute is
                    <emphasis>optional</emphasis>.</para>
                <para>
                    If you do not use the <code>wadl</code> attribute to specify the location of an external WADL, you must embed a WADL within the <code>validator</code> element.
                    In this example, in the validator labeled "VALIDATOR 3", you can see an embedded WADL beginning at <code>&lt;application&gt;</code>.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.dot-output">
                <para>
                    This attribute specifies the location of a visual representation to be generated by this validator, describing the validated WADL as a state machine in .dot format. 
                    If a relative path is specified, then <code>dot-output</code> is a URI relative to the &PRODNAME; configuration directory. 
                    &PRODNAME; must have write access to the location specified by <code>dot-output</code>.
                </para>
                <para>
                    You can see examples of state-machine drawings in the "Optimization" section of <link xlink:href="http://www.balisage.net/Proceedings/vol8/html/Williams01/BalisageVol8-Williams01.html">Using XProc, XSLT 2.0, and XSD 1.1 to validate RESTful services</link>.
                </para>
                <para>
                    If I don't want to bother with a drawing, can I skip it? If I generate a drawing, how can I use it?
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.check-well-formed">
                <para>
                    When set to <code>true</code>, <code>check-well-formed</code> requires validation that the specified WADL's XML is well-formed.</para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.check-xsd-grammar">
                <para>
                    When set to <code>true</code>, <code>check-xsd-grammar</code> requires validation that the specified WADL's conforms to the XSD grammar specified within the WADL.
                    In this example, in the validator labeled "VALIDATOR 3", you can see a grammar stylesheet specified within the embedded WADL.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.check-plain-params">
                <para>
                    When set to <code>true</code>, <code>check-plain-params</code> requires validation of plain parameters.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.do-xsd-grammar-transform">
                <para>
                    When set to <code>true</code>, <code>do-xsd-grammar-transform</code> transforms the WADL's XML after validation. 
                    One use of this transformation is to fill in values that would otherwise be allowed to default. 
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.enable-pre-process-extension">
                <para>
                    When set to <code>true</code>, <code>enable-pre-process-extension</code> enables the pre-process extension for an unknown purpose. 
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.remove-dups">
                <para>
                    When set to <code>true</code>, <code>remove-dups</code> prevents duplicate nodes in the (state?) machine. 
                    When validation encounters a duplicate node, an unknown result occurs. 
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.xpath-version">
                <para>
                    <code>xpath-version</code> specifies the XPath implementation used in validating the WADL. 
                </para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para>
                                When set to <code>1</code>, <code>xpath-version</code> is the Xalan implementation. 
                            </para>
                        </listitem>
                        <listitem>
                            <para>
                                When set to <code>2</code>, <code>xpath-version</code> is the Saxon implementation. 
                                To use Saxon with schema awareness, you must have a Saxon license.
                            </para>
                        </listitem>
                    </itemizedlist>
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.validate-checker">
                <para>
                    When set to <code>true</code>, <code>validate-checker</code> runs pre-validation code to validate that the validator was generated correctly. 
                    If the validator was not generated correctly, perhaps the rest of the process stops. 
                    What would make it be incorrect? 
                    What if it's incorrect and I didn't say to check for that?
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.xsl-engine">
                <para>
                    <code>xsl-engine</code> specifies the XSL 1.0 engine used in validating the WADL. 
                </para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para>
                                When set to <code>Xalan</code>, the Xalan engine is used. 
                            </para>
                        </listitem>
                        <listitem>
                            <para>
                                When set to <code>XalanC</code>, the XalanC engine is used. 
                            </para>
                        </listitem>
                        <listitem>
                            <para>
                                When set to <code>Saxon</code>, the Saxon engine is used. 
                                Saxon is an XSL 2.0 engine, but it works correctly with most 1.0 XSLs.
                            </para>
                        </listitem>
                    </itemizedlist>
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.use-saxon">
                <para>
                    When set to <code>true</code>, <code>use-saxon</code> requires use of Saxon-EE for XSD validation. 
                    Otherwise, the Xerces validator is used for XSD validation.
                    To use Saxon for XSD validation, you must have a Saxon license.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.enable-ignore-xsd-extension">
                <para>
                    When set to <code>true</code>, <code>enable-ignore-xsd-extension</code> enables use of the rax:ignoreXSD extension. 
                    This extension excludes some representations in WADLs from validation against the XSD. 
                    Where can I learn more about the rax:ignoreXSD extension?
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.join-xpath-checks">
                <para>
                    When set to <code>true</code>, <code>join-xpath-checks</code> optimizes performance of the validator
                    by merging <code>check-well-formed</code> and the multiple-XPath check into a single check. If this is optimal, why shouldn't I always do it?
                </para>
                <para> </para>
            </callout>
            <callout arearefs="cfg.check-headers">
                <para>
                    When set to <code>true</code>, <code>join-check-headers</code> requires validation of headers. 
                </para>
                <para> </para>
            </callout>
        </calloutlist>
        </section>
            <section xml:id="Customizing_Response_Messaging-d1e385">
                <title>Customizing a Response Messaging Configuration</title>
                <para>
                    If a request fails validation, then an appropriate <link xlink:href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP response code</link> is returned.  
                    For example:
                    <itemizedlist>
                        <listitem><para>If the validator determines that the URI is invalid, a 404 is returned.</para></listitem>
                        <listitem><para>If the validator determines that the URI is valid but the method is not appropriate for the URI, then a 405 is returned.</para></listitem>
                    </itemizedlist>
                    You can provide an appropriate error message along with the response code by configuring the response messaging service.
                </para>
                <para> 
                    The &PRODNAME; API validation component processes invalid requests based on the response messaging configuration at <code>response-messaging.cfg.xml</code>.
                    To change the response messaging configuration, edit <code>response-messaging.cfg.xml</code> at any time.
                </para>
                <para> A valid response messaging configuration resembles the following
                example: </para>
                <example>
                    <title>Response Messaging Configuration</title>
<programlisting language="xml">
<xi:include href="samples/repose-apivalidation-response-messaging.cfg.xml" parse="text"/>
</programlisting>
                </example>    
                <para>
                    In this example, 
                    only status code 404 receives additional message handling. 
                    In the case of a 404 only, an XML response is formatted as XML (<code><![CDATA[<error-message>%M</error-message>]]></code>)
                    and a JSON response is formatted as JSON (<code><![CDATA[{"error-message": "%M"}]]></code>).
                </para>
        </section>
    </chapter>
    <chapter xml:id="Deployment-d1e105">
        <title>Deployment</title>
        <para> 
            The validation filter is packaged in the extensions filter bundle.  
            When you initially deploy &PRODNAME;, your filter directory should contain <code>filter-bundle-&lt;version&gt;.ear</code>.
            Copy <code>extensions-filter-bundle-&lt;version&gt;.ear</code> to the same directory.
            Then update your <code>system-model.cfg.xml</code> to add &lt;filter name="api-validator"/&gt; to your filter chain. 
        </para>
        <para>
            Once <code>validator.cfg.xml</code> is in place, the EAR file is deployed, and the filter is added to the filter chain list, 
            the filter will begin validating requests against the configured WADLs.
        </para>
        <para>
            The validation filter is dependent upon third party libraries. 
            When running on a servlet container such as Tomcat or Glassfish, you should increase the servlet container's <code>PermGen</code> memory size to accommodate the additional libraries used by the validator.
            The ideal value depends upon your configuration; 
            <code>export JAVA_OPTS="$JAVA_OPTS -XX:MaxPermSize=256m"</code> may be sufficient 
        </para>
    </chapter>
    <chapter xml:id="Optimization-d1e107">
        <title>Optimization</title>
        <para> 
            Talk about how to use all the .dot drawings here.
        </para>
    </chapter>
    <xi:include href="chapters/afterword.xml"/>
</book>
