<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book [
<!-- product name is likely to change; parameterize full name, abbreviated name, expanded name -->
<!ENTITY PRODNAME "Repose">
<!ENTITY PRODABBREV "Repose">
<!ENTITY PRODEXPAND "REstful PrOxy Service Engine">
    <!-- Some useful entities borrowed from HTML -->
    <!ENTITY ndash  "&#x2013;">
    <!ENTITY mdash  "&#x2014;">
    <!ENTITY hellip "&#x2026;">

    <!-- Useful for describing APIs -->
    <!ENTITY GET    '<command xmlns="http://docbook.org/ns/docbook">GET</command>'>
    <!ENTITY PUT    '<command xmlns="http://docbook.org/ns/docbook">PUT</command>'>
    <!ENTITY POST   '<command xmlns="http://docbook.org/ns/docbook">POST</command>'>
    <!ENTITY DELETE '<command xmlns="http://docbook.org/ns/docbook">DELETE</command>'>

    <!ENTITY CHECK  '<inlinemediaobject xmlns="http://docbook.org/ns/docbook">
        <imageobject>
        <imagedata fileref="img/Check_mark_23x20_02.svg"
        format="SVG" scale="60"/>
        </imageobject>
        </inlinemediaobject>'>

    <!ENTITY ARROW  '<inlinemediaobject xmlns="http://docbook.org/ns/docbook">
        <imageobject>
        <imagedata fileref="img/Arrow_east.svg"
        format="SVG" scale="60"/>
        </imageobject>
        </inlinemediaobject>'>
]>
<!-- in BOOK below, add status="draft" to set watermark on cover and left margin -->
<book version="5.0" xmlns="http://docbook.org/ns/docbook"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns:m="http://www.w3.org/1998/Math/MathML"
      xmlns:html="http://www.w3.org/1999/xhtml"
      xml:id="Repose-Logging-Deployment-Guide">
    <?rax pdf.url="../../repose-logging-deploy.pdf"?>
    <title>&PRODNAME; HTTP Logging Filter</title>
    <!-- set watermark on cover and left margin -->
    <?rax status.bar.text.font.size="40px" status.bar.text="DRAFT"?>
    <!-- size line1 & line2 of title on PDF cover -->
    <?rax title.font.size="35px" subtitle.font.size="16px"?>
    <titleabbrev>&PRODABBREV; Operations Handbook</titleabbrev>
    <info>
        <author>
            <personname>
                <firstname/>
                <surname/>
            </personname>
            <affiliation>
                <orgname>Rackspace Cloud</orgname>
            </affiliation>
        </author>
        <copyright>
            <year>2010</year>
            <year>2011</year>
            <year>2012</year>
            <holder>2013</holder>
            <holder>Rackspace US, Inc.</holder>
        </copyright>
        <releaseinfo>v2.8.1</releaseinfo>
        <productname>&PRODNAME;</productname>
        <pubdate>2013-08-07</pubdate>
        <legalnotice role="apache2">
            <annotation>
                <remark>Copyright details are filled in by the template.</remark>
            </annotation>
        </legalnotice>
        <abstract>
            <para>This document is intended for systems administrators
                interested in configuring, installing, and
                troubleshooting the &PRODEXPAND;. </para>
        </abstract>
        <revhistory>
            <revision>
                <date>2013-08-07</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem>
                            <para> I updated the book to match the wiki page.</para>
                        </listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
            <revision>
                <date>2013-04-29</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem><para>I uploaded the document to match Repose's updated xmlns and config. file name</para>
                     </listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
        </revhistory>
        <revhistory>
            <revision>
                <date>2012-02-14</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem><para>Improved sample <code>http-log</code> specification in <xref
                                   linkend="Using_Log-d1e531"/> to
                                include formatting control.</para></listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
            <revision>
                <date>2012-01-30</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem><para>Clarified current limitation to HTTP logging.</para></listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
            <revision>
                <date>2012-01-11</date>
                <revdescription>
                    <itemizedlist spacing="compact">
                        <listitem><para>Initial release.</para></listitem>
                    </itemizedlist>
                </revdescription>
            </revision>
        </revhistory>
    </info>
    <chapter xml:id="Overview-d1e85">
        <title>About This Document</title>
            <para> The purpose of this handbook is to facilitate the
            installation and introduction of the logging component.
            This handbook is not a tutorial. It provides basic
            information that will help you understand logging,but you
            must adapt this information to suit your own
            configuration. </para>
            <para> This handbook is focused on one &PRODNAME; filter.
            Other &PRODNAME; filters are documented in companion
            handbooks. </para></chapter>
    <chapter xml:id="Installation">
        <title>What is the HTTP Logging Filter?</title>
        <para> Repose's HTTP Logging Filter allows you to log
            information of the HTTP requests that are sent to Repose
            and responses through Repose. It is based on the Apache
            HTTPD Logging Standard.</para>
        <para/> 
    
    <mediaobject>
        <imageobject>
            <imagedata fileref="figures/logging-revised.png" format="PNG" align="center"/>
            </imageobject>
    </mediaobject>
    
    </chapter>
        
       
        
        
        
        
   
        
        <chapter xml:id="WHAT-Does-it-do">
            <title> What Does HTTP Logging Do?</title>
            <para> The HTTP Logging filter can be configured to log
            information from the request URI and headers but not
            request message content. The HTTP Logging component can
            log static text that is specified in the HTTP-log format
            attribute and specific information about the
            request/response. </para>
        <para> &PRODNAME;'s HTTP logging component implements a subset
            of the Apache logging functionality described at <link
                xlink:href="http://httpd.apache.org/docs/2.2/mod/mod_log_config.html"
                >http://httpd.apache.org/docs/2.2/mod/mod_log_config.html</link>.
            The table below lists the request and response information
            you may choose to log: </para>
        <para>
            <table width="1032">
                <caption> Logging Options</caption>
                <col width="10%"/>
                <col width="50%"/>
                <col width="2%"/>
                <thead>
                    <tr>
                        <td>Format String</td>
                        <td>Description</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <code>\t</code>
                        </td>
                        <td>
                            <para> Tab </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>\n</code>
                        </td>
                        <td>
                            <para> Newline </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%%</code>
                        </td>
                        <td>
                            <para> Percent sign </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%a</code>
                        </td>
                        <td>
                            <para> Remote IP address </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%A</code>
                        </td>
                        <td>
                            <para> Local IP address </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%b</code>
                        </td>
                        <td>
                            <para> Size of response in bytes,
                                excluding HTTP headers </para>
                            <para>
                                <emphasis role="italic">In CLF format:
                                   uses "-" rather than zero when no
                                   bytes are sent.</emphasis>
                            </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%h</code>
                        </td>
                        <td>
                            <para> Remote host </para>
                        </td>
                    </tr>
                    <tr>
                        <td><code>%{header}i </code>
                            <emphasis role="italic"
                                >required</emphasis></td>
                        <td><para>Request header. Parameters type. If not
                            specified, then the header value is as
                            is.</para></td>
                    </tr>
                    <tr>
                        <td><code>%{header type out- format}i </code>
                            <emphasis role="italic">
                                optional</emphasis></td>
                        <td> <para>Currently, the only type supported is DATE
                            . 
                            Out and In date formats supported are
                            RFC_1123(HTTP-Date) and ISO_8601</para></td>
                    </tr>
                    <tr>
                        <td><code>%{header type out format in format}i  </code>
                            <emphasis role="italic"
                                >optional</emphasis></td>
                        <td><para>If type is specified, the out-format is
                            required. In-format is optional and
                            defaults to RFC_1123for DATE types if not
                            specified.</para></td>
                    </tr>
                    <tr>
                        <td>
                            <code>%m</code>
                        </td>
                        <td>
                            <para> Request method </para>
                        </td>
                    </tr>
                    <tr>
                        <td><code>%{header}o </code>
                            <emphasis role="italic"
                                >required</emphasis></td>
                        
                            <td><para>Response header. Parameters type,
                                out-format and in format are optional.
                                If not specified, then the header
                                value is as is.</para></td>
                        
                    </tr>
                    <tr>
                        <td><code>% {header type out-format}o   </code>
                            <emphasis role="italic"
                                >optional</emphasis></td>
                        <td><para>Currently, the only type supported is
                            DATE. Out and In date formats supported
                            are RFC_1123 (HTTP-Date) and
                            ISO_8601.</para></td>
                    </tr>
                    <tr>
                        <td><code>%{header type out-format
                                in-format}</code>
                            <emphasis role="italic">
                                optional</emphasis></td>
                        <td>
                            <para>If type is specified, the out-format is
                            required. The In-format is optional and
                            defaults to RFC_1123 for DATE types if not
                            specified.</para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%p</code>
                        </td>
                        <td>
                            <para> Canonical port of the server
                                serving the request </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%q</code>
                        </td>
                        <td>
                            <para> Query string </para>
                            <para>
                                <emphasis role="italic">Prepended with
                                   "?" if a query string exists;
                                   otherwise, an empty
                                   string.</emphasis>
                            </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%s</code>
                        </td>
                        <td>
                            <para> Status </para>
                            <para>
                                <emphasis role="italic">For
                                   internally-redirected requests,
                                   this is the status of the original
                                   request.</emphasis>
                            </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%t</code>
                        </td>
                        <td>
                            <para> Time the request was received </para>
                            <para>
                                <emphasis role="italic">Standard
                                   English format. 24 hour
                                   format</emphasis>
                            </para>
                        </td>
                    </tr>
                    <tr>
                        <td><code>%T</code></td>
                        <td>The time taken to serve the request, in
                            seconds</td>
                    </tr>
                    <tr>
                        <td>
                            <code>%u</code>
                        </td>
                        <td>
                            <para> Remote user </para>
                            <para>
                                <emphasis role="italic">May be bogus
                                   if status (<code>%s</code>) is
                                   401.</emphasis>
                            </para>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <code>%U</code>
                        </td>
                        <td>
                            <para> URL path requested, excluding any
                                query string </para>
                        </td>
                    </tr>
                </tbody>
            </table>
        </para>
        </chapter>
    
        
        <chapter xml:id="pREREQS">
            <title> System Prerequisites</title>
            <para> Repose's HTTP Logging component must be deployed on
            a system which supports<emphasis role="bold">
                UTF-8</emphasis>. If the system does not support
                <emphasis role="bold">UTF-8</emphasis>, an error will
            occur during startup and Repose will exit. </para>
        </chapter>
            
            
            <chapter xml:id="Config"> 
               <title> Configuration </title>
<para>The HTTP Logging Component must be added to a Repose deployment as a filter (http-logging filter), this is defined through
    the System Model Config.The HTTP Logging Filter can be configured by editing the <code>http-logging.cfg.xml</code>. Within that 
configuration the user can specify the following:</para>
               <itemizedlist>
                   <listitem>
                       <para> Log(s):The <code>http-log</code> element
                    can be repeated in the configuration  to specify
                    multiple logs.</para>
                
                   </listitem>
                   <listitem>
                       <para>Content of each log: The
                        <code>format</code> attribute within the<code>
                        http-log</code> element can be used to specify
                    what will be logged for each request
                    response.</para>
                   </listitem>
                   <listitem>
                       <para> Targets: The <code>file</code> element
                    can be used to specify the location(s) on the file
                    system of where the log information should be
                    stored. For example: <code>
                        /usr/local/repose.log</code></para>
                   </listitem>
               </itemizedlist>
        <example>
            <title>HTTP Logging Configured for Two Logs</title>
            <programlistingco>
                <areaspec>
                    <area xml:id="logging-config-HTTP.xml.http-logging" units="linecolumn" coords="4 14"/>
                    <area xml:id="logging-config-HTTP.xml.id" units="linecolumn" coords="8 9"/>
                    <area xml:id="logging-config-HTTP.xml.format-detailed" units="linecolumn" coords="9 9"/>
                    <area xml:id="logging-config-HTTP.xml.location" units="linecolumn" coords="12 17"/>
                </areaspec>
            <programlisting language="xml">
<xi:include href="samples/repose-logging-config-HTTP.xml" parse="text"/>
            </programlisting>
            </programlistingco>
        </example>
        <para>
        Key elements of the preceding example are labeled with callouts and explained below: 
        </para>
        <calloutlist>
            <callout arearefs="logging-config-HTTP.xml.http-logging">
                <para>
                    <code>http-logging</code> can have multiple children, 
                    each defined by <code>http-log</code>.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="logging-config-HTTP.xml.id">
                <para>
                    <code>id</code> assigns a label to this log.
                </para>
                <para> </para>
            </callout>
            <callout arearefs="logging-config-HTTP.xml.format-detailed">
                <para>
                    <code>format</code> identifies what to record in this log. 
                    See <xref linkend="Formatting_Log-d1e431"></xref> for help in interpreting <code>format</code>.
                </para>
                 <para> In this example, a tab (<code>\t</code>)
                    separates every item within the record; every
                    record ends by forcing a new line
                    (<code>\n</code>). </para>
                <para> </para>
            </callout>
            <callout arearefs="logging-config-HTTP.xml.location">
                <para>
                    <code>location</code> identifies a file in which to store this log
                </para>
                <para> </para>
            </callout>
        </calloutlist>
                <example>
                    <title> System Model With Logging Configuration</title>
                    <programlisting language="xml">
                     <xi:include href="samples/repose-logging-system-model.xml" parse="text"></xi:include>
                    </programlisting>
                </example>
            </chapter>
    <chapter xml:id="Formatting_Log-d1e431">
        <title>Logging Behavior</title>                 
 <para>
     For responses with specific HTTP status codes, you can restrict what is logged. 
     The table below shows examples of format strings using this functionality:
 </para>     
        <table border="1" frame="box">
            <caption>Examples of Logging Restricted By HTTP Status
                Code</caption>
            <col width="25%"/>
            <col width="75%"/>
            <thead>
                <tr>
                    <td>Format String</td>
                    <td>Description</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <code>%403,401U</code>
                    </td>
                    <td>
                        <para> For 403 and 401 responses only: log the
                            URL path requested. </para>
                    </td>
                </tr>
                <tr>
                    <td>
                        <code>%\!200,304,302U</code>
                    </td>
                    <td>
                        <para> For all responses except 200, 304, and
                            302: log the URL path requested. </para>
                    </td>
                </tr>
            </tbody>
        </table>        
    
    <section xml:id="Using_Log-d1e531">
        <title> Log Access and Use</title>
        <para> The log file is a text file, so it can be viewed with
            any text viewer. Examples of text viewers you can use are
                <emphasis role="bold">gedit</emphasis> (on a GNOME
            Linux system) and <emphasis role="bold">Notepad</emphasis>
            (on a Windows system). </para>
        <para> 
            The log file can be formatted as a tab-delimited file,
            so it can be opened and manipulated as a spreadsheet.
            Examples of spreadsheet software you can use are 
            <emphasis role="bold">OpenOffice.org Calc</emphasis> and
            <emphasis role="bold">Microsoft Excel</emphasis>. 
        </para>
        <para> The log file can be huge, so you may wish to examine it
            via an external parser. Examples of external parsers you
            can use are <emphasis role="bold">Flume</emphasis> and
                <emphasis role="bold">AWStats</emphasis>. </para>
        <para> The log file will grow until it is rotated, moved, or
            deleted. An example of a utility you can configure to
            rotate and archive the log file is <emphasis role="bold"
                >logrotate</emphasis>. </para>    
        <para> The following table shows the HTTP responses and log
            output generated if you specify <code>http-log</code> as<?sbr?>
            <code>format="Remote IP=%a/tLocal IP=%A/tResponse
                Size(bytes)=%b/tRemote Host=%h/tRequest Method=%m/tServer
                Port=%p/tQuery String=%q/tTime Request Received=%t/t
                Status=%s/tRemote User=%u/tURL Path
                Requested=%U"/n</code>. </para>
        
        <table border="1" frame="box">
            <caption>
                    Requests, Responses, and Log Output</caption>
            <col width="25%"/>
            <col width="10%"/>
            <col width="66%"/>
            <thead>
                <tr>
                    <td>Request</td>
                    <th>Response</th>
                    <td>Log Output</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>curl http://localhost:8887/v1/usertest1
                            -H
                        "x-auth-token:358484212:99493"</code></td>
                    <td>200 OK</td>
                    <td>
                        <para> Remote IP=127.0.0.1 Local IP=127.0.0.1
                            Response Size(bytes)=2048 Remote
                            Host=127.0.0.1 Request Method=GET Server
                            Port=8887 Query String=null Time Request
                            Received=13-12-2011-10:17:34.335
                            Status=200 Remote User=usertest1 URL Path
                            Requested=http://localhost:8887/resources/mockendservice/v1/usertest1 </para>
                    </td>
                </tr>
                <tr>
                    <td><code>curl http://localhost:8887/v1/usertest1
                            -H
                        "x-auth-token:358484212:99493"</code></td>
                    <td><errorcode>413</errorcode> Request Entity Too Large</td>
                    <td>
                        <para> Remote IP=127.0.0.1 Local IP=127.0.0.1
                            Response Size(bytes)=2048 Remote
                            Host=127.0.0.1 Request Method=GET Server
                            Port=8887 Query String=null Time Request
                            Received=13-12-2011-10:22:17.320
                            Status=413 Remote User=usertest1 URL Path
                            Requested=http://localhost:8887/resources/mockendservice/v1/usertest1</para>
                    </td>
                </tr>
            </tbody>
        </table> 
    </section>
    </chapter>
<chapter xml:id= "Errors">
    <title> Error Handling</title>
    <para> Buffer Overflow Exception when logging is handled by giving
            possible causes in the error that is logged into Repose
            logs. Current Error Message will state:    "Exception
            coming from HTTP logging filter while writing to log
            buffer." </para>
        <para><emphasis role="bold">Possible Causes:
            </emphasis></para>
        <para>
            <itemizedlist>
                <listitem>
                    <para>Distributed Datastore not being the first
                        filter of the filter chain in the System
                        Model.</para>
                </listitem>
                <listitem>
                    <para>Rate Limit Configuration file (if being
                        used) has capture groups that are too broad
                        and are filling the datastore.</para>
                </listitem>
                <listitem>
                    <para>Limited disk space and http log file size
                        where Repose HTTP logging filter is
                        writing.</para>
                </listitem>
            </itemizedlist>
        </para>
</chapter>
    <xi:include href="chapters/afterword.xml"/>
</book>
